<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Course Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #5568d3;
            --secondary: #764ba2;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-elevated: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border: #334155;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Navbar */
        .navbar {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .navbar-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .navbar-actions {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .role-switch {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: var(--bg-elevated);
            border-radius: 50px;
        }

        .role-switch label {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-elevated);
            border: 2px solid var(--border);
            transition: 0.3s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background-color: var(--text-muted);
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(24px);
            background-color: white;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Page Header */
        .page-header {
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: var(--text-muted);
            font-size: 1rem;
        }

        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        /* Course Grid */
        .course-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        .course-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s;
            cursor: pointer;
        }

        .course-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border-color: var(--primary);
        }

        .course-header {
            margin-bottom: 1rem;
        }

        .course-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .course-instructor {
            color: var(--text-muted);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .course-description {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.6;
            margin-bottom: 1rem;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .course-actions {
            display: flex;
            gap: 0.75rem;
        }

        .course-actions .btn {
            flex: 1;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-muted);
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
        }

        /* Form */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        /* Student List */
        .student-list {
            margin-top: 1.5rem;
        }

        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 0.75rem;
            transition: all 0.2s;
        }

        .student-item:hover {
            background: var(--border);
        }

        .student-info {
            flex: 1;
        }

        .student-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .student-email {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .student-grade {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .grade-badge {
            padding: 0.25rem 0.75rem;
            background: var(--success);
            color: white;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            min-width: 300px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 2000;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        .toast.info {
            border-left: 4px solid var(--primary);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-content">
            <div class="navbar-brand">ðŸ“š EduHub</div>
            <div class="navbar-actions">
                <div class="role-switch" id="roleSwitchContainer" style="display: none;">
                    <label>Student</label>
                    <label class="switch">
                        <input type="checkbox" id="roleSwitch">
                        <span class="slider"></span>
                    </label>
                    <label>Teacher</label>
                </div>
                <div class="user-info" id="userInfo" style="display: none;">
                    <div class="user-avatar" id="userAvatar"></div>
                    <span id="userName"></span>
                    <button class="btn btn-secondary" id="logoutBtn">Logout</button>
                </div>
                <button class="btn btn-primary" id="loginBtn">Login</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <div class="page-header">
            <div class="header-actions">
                <div>
                    <h1 class="page-title" id="pageTitle">Available Courses</h1>
                    <p class="page-subtitle" id="pageSubtitle">Explore and enroll in courses</p>
                </div>
                <button class="btn btn-primary hidden" id="addCourseBtn">+ Add New Course</button>
            </div>
        </div>

        <div id="courseContainer">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading courses...</p>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Student Login</h2>
                <button class="modal-close" onclick="closeModal('loginModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" id="loginName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Course Modal -->
    <div class="modal" id="addCourseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Course</h2>
                <button class="modal-close" onclick="closeModal('addCourseModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="addCourseForm">
                    <div class="form-group">
                        <label class="form-label">Course Title</label>
                        <input type="text" class="form-control" id="courseTitle" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="courseDescription"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Instructor</label>
                        <input type="text" class="form-control" id="courseInstructor" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Add Course</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Course Detail Modal -->
    <div class="modal" id="courseDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="detailCourseTitle"></h2>
                <button class="modal-close" onclick="closeModal('courseDetailModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Instructor</label>
                    <p id="detailCourseInstructor" style="color: var(--text-secondary);"></p>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <p id="detailCourseDescription" style="color: var(--text-secondary);"></p>
                </div>
                <div class="student-list" id="enrolledStudentsList">
                    <label class="form-label">Enrolled Students</label>
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading students...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Grade Student Modal -->
    <div class="modal" id="gradeStudentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Grade Student</h2>
                <button class="modal-close" onclick="closeModal('gradeStudentModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Student</label>
                    <p id="gradeStudentName" style="color: var(--text-secondary);"></p>
                </div>
                <form id="gradeForm">
                    <div class="form-group">
                        <label class="form-label">Grade</label>
                        <input type="text" class="form-control" id="gradeValue" placeholder="e.g., A, B+, 90" required>
                    </div>
                    <button type="submit" class="btn btn-success" style="width: 100%;">Submit Grade</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // Service Endpoints from your docker-compose setup
        const SERVICES = {
            STUDENT: 'http://localhost:4001/graphql',
            COURSE: 'http://localhost:4002/graphql',
            ENROLLMENT: 'http://localhost:4003/graphql'
        };

        let currentUser = JSON.parse(localStorage.getItem('eduHubUser')) || null;
        let isTeacher = false;
        let currentCourseId = null;
        let studentEnrollments = []; // Track current student's course IDs

        async function fetchGraphQL(url, query, variables = {}) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, variables })
                });
                const result = await response.json();
                if (result.errors) throw new Error(result.errors[0].message);
                return result.data;
            } catch (error) {
                showToast(error.message, 'error');
                return null;
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        async function updateUI() {
            const loginBtn = document.getElementById('loginBtn');
            const userInfo = document.getElementById('userInfo');
            const roleSwitchContainer = document.getElementById('roleSwitchContainer');
            const addCourseBtn = document.getElementById('addCourseBtn');

            if (currentUser || isTeacher) {
                loginBtn.style.display = 'none';
                userInfo.style.display = 'flex';
                roleSwitchContainer.style.display = 'flex';
                document.getElementById('userName').textContent = isTeacher ? "Teacher View" : currentUser.nama;
                document.getElementById('userAvatar').textContent = isTeacher ? "T" : currentUser.nama[0];
                addCourseBtn.classList.toggle('hidden', !isTeacher);
                
                // If student is logged in, fetch their enrollments
                if (!isTeacher && currentUser) {
                    const data = await fetchGraphQL(SERVICES.ENROLLMENT, 
                        `query($sid: Int) { enrollmentStudent(studentID: $sid) { courseId } }`, 
                        { sid: parseInt(currentUser.id) }
                    );
                    studentEnrollments = data?.enrollmentStudent.map(e => String(e.courseId)) || [];
                }
            } else {
                loginBtn.style.display = 'block';
                userInfo.style.display = 'none';
                roleSwitchContainer.style.display = 'none';
                addCourseBtn.classList.add('hidden');
                studentEnrollments = [];
            }
            loadCourses();
        }

        async function loadCourses() {
            const container = document.getElementById('courseContainer');
            const data = await fetchGraphQL(SERVICES.COURSE, `query { courses { id title description instructor } }`);
            
            if (!data || !data.courses) return;

            container.innerHTML = data.courses.map(course => {
                const isEnrolled = studentEnrollments.includes(String(course.id));
                
                return `
                <div class="course-card" onclick="viewCourseDetails('${course.id}')">
                    <div class="course-header">
                        <h3 class="course-title">${course.title}</h3>
                        <div class="course-instructor">ðŸ‘¤ ${course.instructor}</div>
                    </div>
                    <p class="course-description">${course.description || 'No description available.'}</p>
                    <div class="course-actions">
                        ${!isTeacher && currentUser ? 
                            `<button class="btn ${isEnrolled ? 'btn-secondary' : 'btn-primary'}" 
                                     onclick="enrollInCourse(event, '${course.id}')" 
                                     ${isEnrolled ? 'disabled' : ''}>
                                ${isEnrolled ? 'Already Enrolled' : 'Enroll'}
                            </button>` : 
                            `<button class="btn btn-secondary">View Details</button>`
                        }
                    </div>
                </div>`;
            }).join('');
        }

        async function enrollInCourse(event, courseId) {
            event.stopPropagation();
            if (!currentUser) return openModal('loginModal');

            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Enrolling...';

            const mutation = `mutation($sid: Int, $cid: Int) {
                enroll(studentID: $sid, courseID: $cid) { id status }
            }`;
            
            const data = await fetchGraphQL(SERVICES.ENROLLMENT, mutation, {
                sid: parseInt(currentUser.id),
                cid: parseInt(courseId)
            });

            if (data) {
                showToast("Enrolled successfully!", "success");
                btn.textContent = 'Already Enrolled';
                btn.className = 'btn btn-secondary';
                studentEnrollments.push(String(courseId)); // Update local state
            } else {
                btn.disabled = false;
                btn.textContent = 'Enroll';
            }
        }

        // 4. View Course Details & Students (Teacher View)
        async function viewCourseDetails(courseId) {
            currentCourseId = courseId;
            const courseData = await fetchGraphQL(SERVICES.COURSE, 
                `query($id: ID) { course(id: $id) { title description instructor } }`, { id: courseId });
            
            if (!courseData) return;

            document.getElementById('detailCourseTitle').textContent = courseData.course.title;
            document.getElementById('detailCourseInstructor').textContent = courseData.course.instructor;
            document.getElementById('detailCourseDescription').textContent = courseData.course.description;
            
            const listContainer = document.getElementById('enrolledStudentsList');
            listContainer.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            openModal('courseDetailModal');

            // Fetch Enrollments for this course
            const enrollData = await fetchGraphQL(SERVICES.ENROLLMENT, 
                `query($id: Int) { enrollmentCourse(courseID: $id) { id studentId } }`, { id: parseInt(courseId) });

            if (enrollData && enrollData.enrollmentCourse.length > 0) {
                let html = '<label class="form-label">Enrolled Students</label>';
                for (const en of enrollData.enrollmentCourse) {
                    // Fetch student name from Student Service
                    const sData = await fetchGraphQL(SERVICES.STUDENT, 
                        `query($id: ID) { student(id: $id) { nama email } }`, { id: en.studentId });
                    
                    // Fetch grade if it exists
                    const gData = await fetchGraphQL(SERVICES.ENROLLMENT,
                        `query($eid: Int) { gradeByEnrollment(enrollmentID: $eid) { grade } }`, { eid: parseInt(en.id) });

                    html += `
                        <div class="student-item">
                            <div class="student-info">
                                <div class="student-name">${sData.student.nama}</div>
                                <div class="student-email">${sData.student.email}</div>
                            </div>
                            <div class="student-grade">
                                ${gData?.gradeByEnrollment ? `<span class="grade-badge">${gData.gradeByEnrollment.grade}</span>` : ''}
                                ${isTeacher ? `<button class="btn btn-secondary btn-sm" onclick="openGradeModal('${en.id}', '${sData.student.nama}')">Grade</button>` : ''}
                            </div>
                        </div>`;
                }
                listContainer.innerHTML = html;
            } else {
                listContainer.innerHTML = '<p class="empty-state">No students enrolled yet.</p>';
            }
        }

        // 5. Grading
        let currentEnrollmentId = null;
        window.openGradeModal = (enrollId, name) => {
            currentEnrollmentId = enrollId;
            document.getElementById('gradeStudentName').textContent = name;
            openModal('gradeStudentModal');
        };

        document.getElementById('gradeForm').onsubmit = async (e) => {
            e.preventDefault();
            const grade = document.getElementById('gradeValue').value;
            const mutation = `mutation($eid: Int, $g: String) { addGrade(enrollmentID: $eid, grade: $g) { id grade } }`;
            
            const data = await fetchGraphQL(SERVICES.ENROLLMENT, mutation, {
                eid: parseInt(currentEnrollmentId),
                g: grade
            });

            if (data) {
                showToast("Grade submitted!", "success");
                closeModal('gradeStudentModal');
                viewCourseDetails(currentCourseId);
            }
        };

        // --- Auth Mockup (Using Register as Login) ---
        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            const mutation = `mutation($n: String, $e: String) {
                createStudent(nama: $n, email: $e, jurusan: "General", enrollmentYear: 2024) { id nama email }
            }`;
            const data = await fetchGraphQL(SERVICES.STUDENT, mutation, {
                n: document.getElementById('loginName').value,
                e: document.getElementById('loginEmail').value
            });

            if (data) {
                currentUser = data.createStudent;
                localStorage.setItem('eduHubUser', JSON.stringify(currentUser));
                closeModal('loginModal');
                updateUI();
                showToast(`Welcome, ${currentUser.nama}!`, 'success');
            }
        };

        // --- Event Listeners ---
        document.getElementById('roleSwitch').onchange = (e) => {
            isTeacher = e.target.checked;
            updateUI();
        };

        document.getElementById('logoutBtn').onclick = () => {
            currentUser = null;
            localStorage.removeItem('eduHubUser');
            updateUI();
        };

        document.getElementById('loginBtn').onclick = () => openModal('loginModal');
        document.getElementById('addCourseBtn').onclick = () => openModal('addCourseModal');

        // Initial Load
        window.onload = updateUI;
    </script>
</body>
</html>